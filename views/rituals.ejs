<!doctype html>
<html>
<% include partials/head %>
<body>
  <div id='content' />
  <% include partials/scripts %>
</body>
<script type="text/babel">
var colors = [
  { name: 'White', tag:'silver'},
  { name: 'Blue', tag:'blue' },
  { name: 'Black', tag:'black' },
  { name: 'Red', tag:'red'},
];
var ColorList = React.createClass(
  {
    render: function(){
       var self = this;
       return (
         <form >
         {this.props.colors.map(function(color){
           return (
             <div key={color.name}>
             <label for='color-{color-name}' style={{color:color.tag, backgroundColor: color.background || 'white'}} >{color.name}</label>
             <input name='color-{color.name}' value={color.quantity} onChange={self.handleChange.bind(self, color.name)}/>
             </div>
             );}
         )}
         </form>
       );
    },
    handleChange: function(colorName, event){
      this.props.onQuantityChange(colorName, event.target.value);
    },
  }
);
var PullList = React.createClass({
    render: function() {
      var self = this;
      return (
        <div>
        <h5>Results: </h5>
        <ol>
        { this.props.pulls.map(function(pull, index){
          var color = self.props.colors.filter(color => color.name == pull)[0];
          return (
            <li key={color.name + '.' + index} style={{color: color.tag}}>{color.name}</li>
          )})}
       </ol>
       </div>
      );
    }
  });

var RitualsApp = React.createClass({
  getInitialState: function() {
    return {
      pulls: [],
      colorQuantities: this.props.colors.map(function(color){return { name:color.name, tag:color.tag, background: color.background, quantity:0 };}),
      pullQuantity: 1
    };
  },

  onQuantityChange: function (colorName, quantity){
        this.state.colorQuantities.filter(color => color.name == colorName).forEach(color => color.quantity = quantity);
        this.setState({
          colorQuantities: this.state.colorQuantities
        });
      },
  onPullQuantityChange: function (event) {
    this.setState({ pullQuantity: event.target.value});
  },
 pullFromBag: function (event){
   event.preventDefault();
   var totalMarbles = 0;
    for(var i = 0, len = this.state.colorQuantities.length; i < len; i++) {
      totalMarbles += +(this.state.colorQuantities[i].quantity);
    }

   var colorWeights = this.state.colorQuantities.map(function(color){ return +((color.quantity / totalMarbles).toFixed(2))});
   var colors = this.state.colorQuantities.map(function(color){return color.name});

   var pulls = [];
   for(var i = 0; i < this.state.pullQuantity; i++) {
     var color = getRandomItem(colors, colorWeights);
     pulls.push(color);
   }
   this.setState({ pulls: pulls});
 },
  render: function() {
    return (
      <div class='row'>
        <h4>Ritual Pulls</h4>
        <ColorList colors={this.state.colorQuantities} onQuantityChange={this.onQuantityChange} />
        <form onSubmit={this.pullFromBag} >
        <input type='text' value={this.state.pullQuantity} onChange={this.onPullQuantityChange} />
        <input type='submit' class='btn btn-primary' value='Pull' />
        </form>
        <PullList colors={this.state.colorQuantities} pulls={this.state.pulls} />
      </div>
    )},
});

ReactDOM.render(<RitualsApp colors={colors} />, document.getElementById('content'));

var rand = function(min, max) {
    return Math.random() * (max - min) + min;
};


var getRandomItem = function(list, weight) {
    var total_weight = weight.reduce(function (prev, cur, i, arr) {
        return prev + cur;
    });

    var random_num = rand(0, total_weight);
    var weight_sum = 0;
    //console.log(random_num)

    for (var i = 0; i < list.length; i++) {
        weight_sum += weight[i];
        weight_sum = +weight_sum.toFixed(2);

        if (random_num <= weight_sum) {
            return list[i];
        }
    }

    // end of function
};
</script>
</html>
